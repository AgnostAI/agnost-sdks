# Agnost Analytics API Documentation

This document describes the REST API endpoints that Agnost SDKs use to communicate with the Agnost Analytics backend.

## Base URL

Production: `https://api.agnost.ai`

Custom deployments may use different base URLs.

## Authentication

All API requests require an organization ID to be provided via the `X-Org-Id` header.

## Common Headers

All endpoints require these headers:

| Header | Value | Description |
|--------|-------|-------------|
| `Content-Type` | `application/json` | Request body format |
| `X-Org-Id` | `{organization_id}` | Your organization identifier |

## Endpoints

### 1. Create Session

Creates a new analytics session for tracking MCP server interactions.

**Endpoint:** `POST /api/v1/capture-session`

**Description:**
A session represents a single connection to an MCP server. Sessions are created when:
- An MCP client connects to the server
- The SDK first initializes tracking
- A new server instance starts

Sessions include metadata about the server configuration, available tools, and optionally user identification.

**Request Body:**

```json
{
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "client_config": "claude-desktop",
  "connection_type": "",
  "ip": "",
  "tools": ["get_weather", "search_web", "calculate"],
  "user_data": {
    "userId": "user123",
    "email": "user@example.com",
    "role": "admin"
  }
}
```

**Request Fields:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `session_id` | string (UUID) | Yes | Unique identifier for this session, generated by SDK |
| `client_config` | string | Yes | Name or identifier of the MCP client (e.g., "claude-desktop", "vscode", "custom-client") |
| `connection_type` | string | No | Type of connection (reserved for future use, can be empty) |
| `ip` | string | No | IP address of the client (reserved for future use, can be empty) |
| `tools` | array[string] | No | List of tool names available on this MCP server |
| `user_data` | object | No | User identification data (shape defined by `identify` function) |

**User Data Fields:**

The `user_data` object is flexible and can contain any fields returned by the SDK's `identify` function. Common fields include:

| Field | Type | Description |
|-------|------|-------------|
| `userId` | string | Unique user identifier (recommended) |
| `email` | string | User's email address |
| `role` | string | User's role or permission level |
| `name` | string | User's display name |
| *(custom)* | any | Any additional custom fields |

**Response:**

```json
{
  "session_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

**Response Codes:**

| Code | Description |
|------|-------------|
| `200 OK` | Session created successfully |
| `201 Created` | Session created successfully (alternative) |
| `400 Bad Request` | Invalid request body |
| `401 Unauthorized` | Missing or invalid organization ID |
| `500 Internal Server Error` | Server error |

**Example (curl):**

```bash
curl -X POST https://api.agnost.ai/api/v1/capture-session \
  -H "Content-Type: application/json" \
  -H "X-Org-Id: your-org-id" \
  -d '{
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "client_config": "claude-desktop",
    "connection_type": "",
    "ip": "",
    "tools": ["get_weather", "search_web"],
    "user_data": {
      "userId": "user123",
      "email": "user@example.com"
    }
  }'
```

**Example (TypeScript SDK):**

```typescript
import { trackMCP } from 'agnost';
import { Server } from '@modelcontextprotocol/sdk/server/index.js';

const server = new Server({ name: 'my-server', version: '1.0.0' }, {});

// Session is created automatically when tracking starts
trackMCP(server, 'your-org-id', {
  identify: (req, env) => ({
    userId: env?.USER_ID || 'anonymous',
    email: env?.USER_EMAIL
  })
});
```

---

### 2. Record Event

Records an analytics event for a tool, resource, or prompt execution.

**Endpoint:** `POST /api/v1/capture-event`

**Description:**
Events track individual interactions with MCP primitives (tools, resources, prompts). Each event includes:
- What was called (primitive type and name)
- Performance metrics (latency)
- Success/failure status
- Optionally, input arguments and output results

**Request Body:**

```json
{
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "primitive_type": "tool",
  "primitive_name": "get_weather",
  "latency": 342,
  "success": true,
  "args": "{\"location\":\"San Francisco\",\"units\":\"celsius\"}",
  "result": "{\"temperature\":18,\"conditions\":\"partly cloudy\"}"
}
```

**Request Fields:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `session_id` | string (UUID) | Yes | Session ID from the session creation response |
| `primitive_type` | string | Yes | Type of primitive: `"tool"`, `"resource"`, or `"prompt"` |
| `primitive_name` | string | Yes | Name of the tool/resource/prompt that was called |
| `latency` | number | Yes | Execution time in milliseconds |
| `success` | boolean | Yes | Whether the execution succeeded (`true`) or failed (`false`) |
| `args` | string | No | JSON-encoded string of input arguments. Omitted if `disableInput: true` |
| `result` | string | No | JSON-encoded string of output/result. Omitted if `disableOutput: true` |

**Primitive Types:**

| Type | Description | Example |
|------|-------------|---------|
| `tool` | MCP tool execution | `get_weather`, `search_database`, `send_email` |
| `resource` | MCP resource access | `file://readme.txt`, `db://users` |
| `prompt` | MCP prompt usage | `code_review_template`, `summarize_text` |

**Response:**

```json
{
  "success": true,
  "event_id": "evt_abc123def456"
}
```

**Response Codes:**

| Code | Description |
|------|-------------|
| `200 OK` | Event recorded successfully |
| `201 Created` | Event recorded successfully (alternative) |
| `400 Bad Request` | Invalid request body |
| `401 Unauthorized` | Missing or invalid organization ID |
| `404 Not Found` | Session ID not found |
| `500 Internal Server Error` | Server error |

**Example (curl):**

```bash
curl -X POST https://api.agnost.ai/api/v1/capture-event \
  -H "Content-Type: application/json" \
  -H "X-Org-Id: your-org-id" \
  -d '{
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "primitive_type": "tool",
    "primitive_name": "get_weather",
    "latency": 342,
    "success": true,
    "args": "{\"location\":\"San Francisco\"}",
    "result": "{\"temperature\":18}"
  }'
```

**Example (TypeScript SDK):**

```typescript
// Events are recorded automatically when tools are called through the tracked server
// The SDK intercepts tool calls and sends events in the background
```

**Example (Python SDK):**

```python
from agnost import track
from mcp.server import FastMCP

server = FastMCP()

@server.tool()
def get_weather(location: str) -> dict:
    # Events are automatically recorded for this tool
    return {"temperature": 18, "conditions": "partly cloudy"}

track(server, "your-org-id")
```

---

## SDK Behavior

### Batching and Queuing

SDKs implement intelligent batching and queuing to optimize API usage:

**TypeScript:**
- Events are queued and sent in batches (default: 5 events per batch)
- Configurable via `batchSize` option
- Can be disabled with `enableRequestQueuing: false`

**Python:**
- Events are processed in a background thread
- Queued and sent individually (no batching by default)

**Golang:**
- Events are queued in a buffered channel
- Batched and flushed every 5 seconds or when batch is full (default: 5 events)
- Configurable via `BatchSize` option

### Retry Logic

**TypeScript:**
- Configurable retry attempts (default: 3)
- Configurable retry delay (default: 1000ms)

**Python:**
- No automatic retries (logged as errors)

**Golang:**
- Configurable retry attempts (default: 3)
- Configurable retry delay (default: 1 second)

### Error Handling

All SDKs follow a **fail-safe** approach:
- Analytics failures do not disrupt MCP server operation
- Failed API calls are logged but not propagated
- Tool execution continues even if event recording fails

### Session Caching

Sessions are cached by the SDK to avoid redundant API calls:
- Session IDs are stored in memory by session key
- Same session ID is reused for the lifetime of the server instance
- Cache is cleared on SDK shutdown

### Privacy Controls

SDKs respect privacy configuration:

**Disable Input Tracking:**
```typescript
trackMCP(server, 'org-id', { disableInput: true });
```
When enabled, `args` field is omitted from event requests.

**Disable Output Tracking:**
```typescript
trackMCP(server, 'org-id', { disableOutput: true });
```
When enabled, `result` field is omitted from event requests.

---

## Rate Limiting

*Note: Current implementation does not enforce rate limits, but this may change in future versions.*

Recommended practices:
- Use SDK's built-in batching to reduce request volume
- Implement exponential backoff for retries
- Monitor your organization's API usage

---

## Errors and Troubleshooting

### Common Error Scenarios

**400 Bad Request**
- Missing required fields
- Invalid JSON format
- Invalid UUID format for `session_id`

**401 Unauthorized**
- Missing `X-Org-Id` header
- Invalid organization ID
- Organization not active

**404 Not Found**
- Session ID does not exist (for events)
- Ensure session is created before sending events

**500 Internal Server Error**
- Contact support with request details

### Debug Logging

Enable debug logging in SDKs to troubleshoot API issues:

**TypeScript:**
```typescript
import { logger } from 'agnost';
// Set log level to debug (requires internal access)
```

**Python:**
```python
import logging
logging.getLogger("agnost").setLevel(logging.DEBUG)
```

**Golang:**
```go
import "github.com/agnostai/agnost-go/agnost"

agnost.Track(server, "org-id", &agnost.Config{
    LogLevel: "debug",
})
```

---

## API Versioning

Current API version: **v1**

Version is specified in the URL path: `/api/v1/...`

Future versions will use `/api/v2/`, `/api/v3/`, etc.

---

## Support

For API issues or questions:
- Documentation: https://docs.agnost.ai
- GitHub Issues: https://github.com/agnostai/agnost-sdks/issues
